services:
  # Service principal: TM20 Server (HTTP + WebSocket sur port 7788)
  - type: web
    name: tm20-server
    runtime: docker
    dockerfilePath: ./Dockerfile
    dockerContext: .

    # Port unique pour HTTP + WebSocket
    # Render mappe automatiquement ce port vers l'extérieur
    envVars:
      - key: PORT
        value: 7788

      - key: DEBUG
        value: 0

      - key: DJANGO_SECRET_KEY
        generateValue: true

      - key: ALLOWED_HOSTS
        value: .onrender.com

      # Base de données PostgreSQL (Render managed)
      - key: DATABASE_URL
        fromDatabase:
          name: tm20-db
          property: connectionString

      # Redis (Render managed)
      - key: REDIS_URL
        fromService:
          type: redis
          name: tm20-redis
          property: connectionString

      # Configuration TM20
      - key: TM20_WEBSOCKET_PORT
        value: 7788

      - key: TM20_HEARTBEAT_INTERVAL
        value: 30

      - key: TM20_CONNECTION_TIMEOUT
        value: 120

    # Healthcheck
    healthCheckPath: /admin/login/

    # Scaling pour 100+ terminaux
    plan: standard # ou pro pour plus de ressources

    # Auto-deploy depuis la branche main
    autoDeploy: true
    branch: main

  # Base de données PostgreSQL
  - type: pserv
    name: tm20-db
    runtime: postgresql
    plan: starter # ou standard pour production
    databaseName: tm20_db
    databaseUser: tm20_user

  # Redis pour Channel Layer + Cache
  - type: redis
    name: tm20-redis
    plan: starter # ou standard pour production
    maxmemoryPolicy: allkeys-lru
    ipAllowList: [] # Accessible uniquement depuis les services Render
