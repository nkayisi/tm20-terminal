<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TM20 Dashboard - Monitoring Temps Réel</title>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script
      src="https://unpkg.com/alpinejs@3.13.3/dist/cdn.min.js"
      defer
    ></script>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <style>
      :root {
        --bs-body-bg: #f8f9fa;
      }
      .stat-card {
        transition: transform 0.2s;
      }
      .stat-card:hover {
        transform: translateY(-2px);
      }
      .stat-value {
        font-size: 2.5rem;
        font-weight: 700;
      }
      .terminal-row {
        transition: background-color 0.3s;
      }
      .terminal-row:hover {
        background-color: rgba(0, 0, 0, 0.02);
      }
      .status-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 8px;
      }
      .status-online {
        background-color: #198754;
      }
      .status-idle {
        background-color: #ffc107;
      }
      .status-offline {
        background-color: #dc3545;
      }
      .log-entry {
        padding: 8px 12px;
        border-bottom: 1px solid #eee;
        font-size: 0.9rem;
      }
      .log-entry:hover {
        background-color: #f8f9fa;
      }
      .pulse {
        animation: pulse 2s infinite;
      }
      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }
      .event-badge {
        font-size: 0.7rem;
        padding: 2px 6px;
      }
    </style>
  </head>
  <body x-data="dashboard()">
    <nav class="navbar navbar-dark bg-dark">
      <div class="container-fluid">
        <span class="navbar-brand mb-0 h1">
          <i class="bi bi-cpu"></i> TM20 Dashboard
        </span>
        <span class="navbar-text">
          <span x-show="connected" class="badge bg-success">
            <i class="bi bi-circle-fill pulse"></i> Connecté
          </span>
          <span x-show="!connected" class="badge bg-danger">
            <i class="bi bi-circle"></i> Déconnecté
          </span>
        </span>
      </div>
    </nav>

    <div class="container-fluid py-4">
      <!-- Stats Cards -->
      <div class="row g-4 mb-4">
        <div class="col-md-3">
          <div class="card stat-card h-100 border-0 shadow-sm">
            <div class="card-body">
              <div class="d-flex justify-content-between">
                <div>
                  <h6 class="text-muted mb-2">Terminaux Connectés</h6>
                  <div class="stat-value text-primary" x-text="stats.connected">
                    0
                  </div>
                </div>
                <div class="align-self-center">
                  <i
                    class="bi bi-router text-primary"
                    style="font-size: 2.5rem; opacity: 0.3"
                  ></i>
                </div>
              </div>
              <small class="text-muted">
                sur <span x-text="stats.total">0</span> enregistrés
              </small>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card stat-card h-100 border-0 shadow-sm">
            <div class="card-body">
              <div class="d-flex justify-content-between">
                <div>
                  <h6 class="text-muted mb-2">Pointages Aujourd'hui</h6>
                  <div class="stat-value text-success" x-text="stats.logsToday">
                    0
                  </div>
                </div>
                <div class="align-self-center">
                  <i
                    class="bi bi-person-check text-success"
                    style="font-size: 2.5rem; opacity: 0.3"
                  ></i>
                </div>
              </div>
              <small class="text-muted">
                <span x-text="stats.logsRate">0</span> /sec
              </small>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card stat-card h-100 border-0 shadow-sm">
            <div class="card-body">
              <div class="d-flex justify-content-between">
                <div>
                  <h6 class="text-muted mb-2">Messages</h6>
                  <div class="stat-value text-info" x-text="stats.messages">
                    0
                  </div>
                </div>
                <div class="align-self-center">
                  <i
                    class="bi bi-envelope text-info"
                    style="font-size: 2.5rem; opacity: 0.3"
                  ></i>
                </div>
              </div>
              <small class="text-muted">
                <span x-text="stats.messageRate">0</span> /sec
              </small>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card stat-card h-100 border-0 shadow-sm">
            <div class="card-body">
              <div class="d-flex justify-content-between">
                <div>
                  <h6 class="text-muted mb-2">Latence Moyenne</h6>
                  <div
                    class="stat-value text-warning"
                    x-text="stats.latency + 'ms'"
                  >
                    0ms
                  </div>
                </div>
                <div class="align-self-center">
                  <i
                    class="bi bi-speedometer2 text-warning"
                    style="font-size: 2.5rem; opacity: 0.3"
                  ></i>
                </div>
              </div>
              <small class="text-muted"
                >P95: <span x-text="stats.latencyP95">0</span>ms</small
              >
            </div>
          </div>
        </div>
      </div>

      <div class="row g-4">
        <!-- Terminals List -->
        <div class="col-lg-6">
          <div class="card border-0 shadow-sm h-100">
            <div
              class="card-header bg-white border-0 d-flex justify-content-between align-items-center"
            >
              <h5 class="mb-0"><i class="bi bi-cpu me-2"></i>Terminaux</h5>
              <button
                class="btn btn-sm btn-outline-primary"
                @click="refreshTerminals()"
              >
                <i class="bi bi-arrow-clockwise"></i>
              </button>
            </div>
            <div class="card-body p-0">
              <div class="table-responsive">
                <table class="table table-hover mb-0">
                  <thead class="table-light">
                    <tr>
                      <th>Statut</th>
                      <th>SN</th>
                      <th>Modèle</th>
                      <th>Dernière activité</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    <template x-for="terminal in terminals" :key="terminal.sn">
                      <tr class="terminal-row">
                        <td>
                          <span
                            class="status-dot"
                            :class="'status-' + terminal.status"
                          ></span>
                          <span
                            x-text="terminal.status"
                            class="text-capitalize"
                          ></span>
                        </td>
                        <td><code x-text="terminal.sn"></code></td>
                        <td x-text="terminal.model"></td>
                        <td x-text="terminal.last_seen_human"></td>
                        <td>
                          <div class="btn-group btn-group-sm">
                            <button
                              class="btn btn-outline-success"
                              @click="sendCommand(terminal.sn, 'opendoor')"
                              title="Ouvrir porte"
                            >
                              <i class="bi bi-door-open"></i>
                            </button>
                            <button
                              class="btn btn-outline-primary"
                              @click="sendCommand(terminal.sn, 'settime')"
                              title="Sync heure"
                            >
                              <i class="bi bi-clock"></i>
                            </button>
                            <button
                              class="btn btn-outline-warning"
                              @click="sendCommand(terminal.sn, 'reboot')"
                              title="Redémarrer"
                            >
                              <i class="bi bi-arrow-repeat"></i>
                            </button>
                          </div>
                        </td>
                      </tr>
                    </template>
                    <tr x-show="terminals.length === 0">
                      <td colspan="5" class="text-center text-muted py-4">
                        Aucun terminal enregistré
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- Recent Logs -->
        <div class="col-lg-6">
          <div class="card border-0 shadow-sm h-100">
            <div
              class="card-header bg-white border-0 d-flex justify-content-between align-items-center"
            >
              <h5 class="mb-0">
                <i class="bi bi-list-ul me-2"></i>Pointages Récents
              </h5>
              <button
                class="btn btn-sm btn-outline-primary"
                @click="refreshLogs()"
              >
                <i class="bi bi-arrow-clockwise"></i>
              </button>
            </div>
            <div
              class="card-body p-0"
              style="max-height: 400px; overflow-y: auto"
            >
              <template x-for="log in logs" :key="log.id">
                <div
                  class="log-entry d-flex justify-content-between align-items-center"
                >
                  <div>
                    <span
                      class="badge"
                      :class="'bg-' + log.inout_class"
                      x-text="log.inout"
                    ></span>
                    <strong x-text="log.user_name" class="ms-2"></strong>
                    <small
                      class="text-muted ms-2"
                      x-text="'(' + log.sn + ')'"
                    ></small>
                  </div>
                  <div class="text-muted">
                    <small x-text="log.time_human"></small>
                  </div>
                </div>
              </template>
              <div
                x-show="logs.length === 0"
                class="text-center text-muted py-4"
              >
                Aucun pointage récent
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Events Timeline -->
      <div class="row mt-4">
        <div class="col-12">
          <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-0">
              <h5 class="mb-0">
                <i class="bi bi-activity me-2"></i>Événements Récents
              </h5>
            </div>
            <div
              class="card-body p-0"
              style="max-height: 200px; overflow-y: auto"
            >
              <template x-for="(event, index) in events" :key="index">
                <div
                  class="log-entry d-flex justify-content-between align-items-center"
                >
                  <div>
                    <span
                      class="badge event-badge"
                      :class="getEventBadgeClass(event.event_type)"
                      x-text="event.event_type"
                    ></span>
                    <span class="ms-2" x-text="formatEventData(event)"></span>
                  </div>
                  <small
                    class="text-muted"
                    x-text="formatTime(event.timestamp)"
                  ></small>
                </div>
              </template>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Toast Notifications -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
      <template x-for="toast in toasts" :key="toast.id">
        <div class="toast show" role="alert">
          <div class="toast-header">
            <strong class="me-auto" x-text="toast.title"></strong>
            <button
              type="button"
              class="btn-close"
              @click="removeToast(toast.id)"
            ></button>
          </div>
          <div class="toast-body" x-text="toast.message"></div>
        </div>
      </template>
    </div>

    <script>
      function dashboard() {
        return {
          connected: false,
          ws: null,
          stats: {
            connected: 0,
            total: 0,
            logsToday: 0,
            logsRate: 0,
            messages: 0,
            messageRate: 0,
            latency: 0,
            latencyP95: 0,
          },
          terminals: [],
          logs: [],
          events: [],
          toasts: [],
          toastId: 0,

          init() {
            this.connectWebSocket();
            this.refreshAll();

            // Auto-refresh toutes les 30 secondes
            setInterval(() => this.refreshAll(), 30000);
          },

          connectWebSocket() {
            const protocol =
              window.location.protocol === "https:" ? "wss:" : "ws:";
            const wsUrl = `${protocol}//${window.location.host}/ws/dashboard/`;

            this.ws = new WebSocket(wsUrl);

            this.ws.onopen = () => {
              this.connected = true;
              this.showToast("Connecté", "WebSocket connecté", "success");
            };

            this.ws.onclose = () => {
              this.connected = false;
              setTimeout(() => this.connectWebSocket(), 5000);
            };

            this.ws.onmessage = (event) => {
              const data = JSON.parse(event.data);
              this.handleMessage(data);
            };
          },

          handleMessage(data) {
            switch (data.type) {
              case "metrics":
                this.updateMetrics(data.data);
                break;
              case "terminals":
                // Merge avec les données existantes
                break;
              case "event":
                this.events.unshift(data);
                if (this.events.length > 50) {
                  this.events = this.events.slice(0, 50);
                }
                this.handleEvent(data);
                break;
            }
          },

          handleEvent(event) {
            if (
              event.event_type === "DEVICE_CONNECTED" ||
              event.event_type === "DEVICE_DISCONNECTED"
            ) {
              this.refreshTerminals();
            }
            if (event.event_type === "ATTENDANCE_LOG_RECEIVED") {
              this.refreshLogs();
            }
          },

          updateMetrics(metrics) {
            if (metrics.connections) {
              this.stats.connected = metrics.connections.active;
            }
            if (metrics.messages) {
              this.stats.messages = metrics.messages.received;
              this.stats.messageRate = metrics.messages.rate_per_second;
            }
            if (metrics.logs) {
              this.stats.logsRate = metrics.logs.rate_per_second;
            }
            if (metrics.latency) {
              this.stats.latency = metrics.latency.message_avg_ms;
              this.stats.latencyP95 = metrics.latency.message_p95_ms;
            }
          },

          async refreshAll() {
            await Promise.all([
              this.refreshStats(),
              this.refreshTerminals(),
              this.refreshLogs(),
            ]);
          },

          async refreshStats() {
            try {
              const response = await fetch("/dashboard/api/");
              const data = await response.json();

              this.stats.total = data.terminals.total;
              this.stats.connected = data.terminals.connected;
              this.stats.logsToday = data.logs.today;
              this.stats.logsRate = data.logs.rate_per_second;

              if (data.metrics) {
                this.updateMetrics(data.metrics);
              }
            } catch (e) {
              console.error("Error refreshing stats:", e);
            }
          },

          async refreshTerminals() {
            try {
              const response = await fetch("/dashboard/api/terminals/");
              const data = await response.json();
              this.terminals = data.terminals;
            } catch (e) {
              console.error("Error refreshing terminals:", e);
            }
          },

          async refreshLogs() {
            try {
              const response = await fetch("/dashboard/api/logs/?limit=20");
              const data = await response.json();
              this.logs = data.logs;
            } catch (e) {
              console.error("Error refreshing logs:", e);
            }
          },

          async sendCommand(sn, command) {
            try {
              const response = await fetch(`/dashboard/api/command/${sn}/`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ command: command }),
              });
              const data = await response.json();

              if (data.success) {
                const msg = data.sent_immediately
                  ? "Commande envoyée"
                  : "Commande en file d'attente";
                this.showToast(command, msg, "success");
              } else {
                this.showToast("Erreur", data.error, "danger");
              }
            } catch (e) {
              this.showToast("Erreur", "Échec de l'envoi", "danger");
            }
          },

          getEventBadgeClass(eventType) {
            const classes = {
              DEVICE_CONNECTED: "bg-success",
              DEVICE_DISCONNECTED: "bg-danger",
              DEVICE_REGISTERED: "bg-primary",
              ATTENDANCE_LOG_RECEIVED: "bg-info",
              COMMAND_SENT: "bg-warning",
              ERROR_OCCURRED: "bg-danger",
            };
            return classes[eventType] || "bg-secondary";
          },

          formatEventData(event) {
            if (event.data.sn) {
              return `Terminal: ${event.data.sn}`;
            }
            return JSON.stringify(event.data).slice(0, 50);
          },

          formatTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleTimeString();
          },

          showToast(title, message, type = "info") {
            const id = ++this.toastId;
            this.toasts.push({ id, title, message, type });
            setTimeout(() => this.removeToast(id), 5000);
          },

          removeToast(id) {
            this.toasts = this.toasts.filter((t) => t.id !== id);
          },
        };
      }
    </script>
  </body>
</html>
