{% extends "devices/dashboard/base.html" %} 
{% block title %}Monitoring Temps Réel{% endblock %} 
{% block extra_css %}
<script src="https://unpkg.com/htmx.org@1.9.10"></script>
<style>
  .pulse-dot {
    animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
  }

  @keyframes pulse {
    0%,
    100% {
      opacity: 1;
    }
    50% {
      opacity: 0.5;
    }
  }

  .status-indicator {
    position: relative;
    display: inline-block;
    width: 8px;
    height: 8px;
    border-radius: 50%;
  }

  .status-indicator.online {
    background-color: #10b981;
    box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
    animation: pulse-ring 2s infinite;
  }

  .status-indicator.offline {
    background-color: #ef4444;
  }

  @keyframes pulse-ring {
    0% {
      box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
    }
    70% {
      box-shadow: 0 0 0 6px rgba(16, 185, 129, 0);
    }
    100% {
      box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);
    }
  }
</style>
{% endblock %} {% block content %}
<div x-data="dashboard()" x-init="init()" class="space-y-6 animate-fade-in">
  <!-- Connection Status Badge -->
  <div class="fixed top-20 right-6 z-40">
    <div
      x-show="connected"
      class="flex items-center px-4 py-2 bg-green-50 border border-green-200 rounded-lg shadow-lg"
    >
      <span class="status-indicator online mr-2"></span>
      <span class="text-sm font-medium text-green-800">Connecté</span>
    </div>
    <div
      x-show="!connected"
      class="flex items-center px-4 py-2 bg-red-50 border border-red-200 rounded-lg shadow-lg"
    >
      <span class="status-indicator offline mr-2"></span>
      <span class="text-sm font-medium text-red-800">Déconnecté</span>
    </div>
  </div>

  <!-- Page Header -->
  <div>
    <h1 class="text-3xl font-bold text-gray-900">Monitoring Temps Réel</h1>
    <p class="mt-1 text-sm text-gray-500">
      Surveillance en direct des terminaux biométriques
    </p>
  </div>

  <!-- Stats Grid -->
  <div class="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-4">
    <!-- Connected Terminals -->
    <div
      class="stat-card bg-white rounded-xl shadow-sm border border-gray-200 p-6 card-hover"
      style="--tw-gradient-from: #10b981; --tw-gradient-to: #059669"
    >
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm font-medium text-gray-600">Terminaux Connectés</p>
          <p
            class="mt-2 text-3xl font-bold text-gray-900"
            x-text="stats.connected + ' / ' + stats.total"
          ></p>
        </div>
        <div
          class="w-12 h-12 rounded-lg bg-green-50 flex items-center justify-center"
        >
          <svg
            class="w-6 h-6 text-green-600"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"
            ></path>
          </svg>
        </div>
      </div>
    </div>

    <!-- Logs Today -->
    <div
      class="stat-card bg-white rounded-xl shadow-sm border border-gray-200 p-6 card-hover"
      style="--tw-gradient-from: #0ea5e9; --tw-gradient-to: #0284c7"
    >
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm font-medium text-gray-600">Pointages Aujourd'hui</p>
          <p
            class="mt-2 text-3xl font-bold text-gray-900"
            x-text="stats.logsToday"
          ></p>
          <p
            class="mt-1 text-xs text-gray-500"
            x-text="stats.logsRate + '/min'"
          ></p>
        </div>
        <div
          class="w-12 h-12 rounded-lg bg-blue-50 flex items-center justify-center"
        >
          <svg
            class="w-6 h-6 text-blue-600"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
            ></path>
          </svg>
        </div>
      </div>
    </div>

    <!-- Messages -->
    <div
      class="stat-card bg-white rounded-xl shadow-sm border border-gray-200 p-6 card-hover"
      style="--tw-gradient-from: #8b5cf6; --tw-gradient-to: #7c3aed"
    >
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm font-medium text-gray-600">Messages WebSocket</p>
          <p
            class="mt-2 text-3xl font-bold text-gray-900"
            x-text="stats.messages"
          ></p>
          <p
            class="mt-1 text-xs text-gray-500"
            x-text="stats.messageRate + '/s'"
          ></p>
        </div>
        <div
          class="w-12 h-12 rounded-lg bg-purple-50 flex items-center justify-center"
        >
          <svg
            class="w-6 h-6 text-purple-600"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"
            ></path>
          </svg>
        </div>
      </div>
    </div>

    <!-- Latency -->
    <div
      class="stat-card bg-white rounded-xl shadow-sm border border-gray-200 p-6 card-hover"
      style="--tw-gradient-from: #f59e0b; --tw-gradient-to: #d97706"
    >
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm font-medium text-gray-600">Latence Moyenne</p>
          <p
            class="mt-2 text-3xl font-bold text-gray-900"
            x-text="stats.latency + 'ms'"
          ></p>
          <p
            class="mt-1 text-xs text-gray-500"
            x-text="'P95: ' + stats.latencyP95 + 'ms'"
          ></p>
        </div>
        <div
          class="w-12 h-12 rounded-lg bg-yellow-50 flex items-center justify-center"
        >
          <svg
            class="w-6 h-6 text-yellow-600"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M13 10V3L4 14h7v7l9-11h-7z"
            ></path>
          </svg>
        </div>
      </div>
    </div>
  </div>

  <!-- Terminals and Logs Grid -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- Terminals List -->
    <div
      class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden"
    >
      <div class="px-6 py-4 border-b border-gray-200">
        <h3 class="text-lg font-semibold text-gray-900">Terminaux</h3>
      </div>
      <div
        class="divide-y divide-gray-200 max-h-96 overflow-y-auto scrollbar-thin"
      >
        <template x-for="terminal in terminals" :key="terminal.id">
          <div
            class="px-6 py-4 hover:bg-gray-50 transition-colors duration-150"
          >
            <div class="flex items-center justify-between">
              <div class="flex items-center space-x-3">
                <div
                  class="w-10 h-10 rounded-lg bg-gradient-to-br from-primary-400 to-primary-600 flex items-center justify-center text-white font-semibold text-sm"
                  x-text="terminal.sn.substring(0, 2).toUpperCase()"
                ></div>
                <div>
                  <p
                    class="text-sm font-medium text-gray-900"
                    x-text="terminal.sn"
                  ></p>
                  <p
                    class="text-xs text-gray-500"
                    x-text="terminal.model || 'TM20'"
                  ></p>
                </div>
              </div>
              <div class="flex items-center space-x-2">
                <span
                  x-show="terminal.connected"
                  class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800"
                >
                  <span class="status-indicator online mr-1.5"></span>
                  En ligne
                </span>
                <span
                  x-show="!terminal.connected"
                  class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800"
                >
                  <span class="status-indicator offline mr-1.5"></span>
                  Hors ligne
                </span>
              </div>
            </div>
            <div class="mt-2 flex items-center space-x-4 text-xs text-gray-500">
              <span
                x-text="'Utilisateurs: ' + (terminal.users_count || 0)"
              ></span>
              <span x-text="'Logs: ' + (terminal.logs_count || 0)"></span>
              <span
                x-show="terminal.last_seen"
                x-text="'Vu: ' + formatTime(terminal.last_seen)"
              ></span>
            </div>
          </div>
        </template>
        <div x-show="terminals.length === 0" class="p-12 text-center">
          <svg
            class="w-12 h-12 mx-auto text-gray-400 mb-2"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"
            ></path>
          </svg>
          <p class="text-sm text-gray-500">Aucun terminal</p>
        </div>
      </div>
    </div>

    <!-- Recent Logs -->
    <div
      class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden"
    >
      <div class="px-6 py-4 border-b border-gray-200">
        <h3 class="text-lg font-semibold text-gray-900">Pointages Récents</h3>
      </div>
      <div
        class="divide-y divide-gray-200 max-h-96 overflow-y-auto scrollbar-thin"
      >
        <template x-for="log in logs" :key="log.id">
          <div
            class="px-6 py-3 hover:bg-gray-50 transition-colors duration-150 animate-slide-up"
          >
            <div class="flex items-center justify-between">
              <div class="flex items-center space-x-3">
                <div
                  class="w-8 h-8 rounded-full bg-gradient-to-br from-blue-400 to-blue-600 flex items-center justify-center text-white text-xs font-semibold"
                  x-text="log.user_name ? log.user_name.substring(0, 2).toUpperCase() : log.enrollid"
                ></div>
                <div>
                  <p
                    class="text-sm font-medium text-gray-900"
                    x-text="log.user_name || 'ID: ' + log.enrollid"
                  ></p>
                  <p class="text-xs text-gray-500" x-text="log.terminal_sn"></p>
                </div>
              </div>
              <div class="text-right">
                <span
                  x-show="log.inout === 0"
                  class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800"
                  >Entrée</span
                >
                <span
                  x-show="log.inout !== 0"
                  class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800"
                  >Sortie</span
                >
                <p
                  class="text-xs text-gray-500 mt-1"
                  x-text="formatTime(log.time)"
                ></p>
              </div>
            </div>
          </div>
        </template>
        <div x-show="logs.length === 0" class="p-12 text-center">
          <svg
            class="w-12 h-12 mx-auto text-gray-400 mb-2"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
            ></path>
          </svg>
          <p class="text-sm text-gray-500">Aucun pointage récent</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Events Log -->
  <div
    class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden"
  >
    <div class="px-6 py-4 border-b border-gray-200">
      <h3 class="text-lg font-semibold text-gray-900">Événements Système</h3>
    </div>
    <div
      class="divide-y divide-gray-200 max-h-64 overflow-y-auto scrollbar-thin"
    >
      <template x-for="event in events" :key="event.id">
        <div class="px-6 py-3 hover:bg-gray-50 transition-colors duration-150">
          <div class="flex items-start space-x-3">
            <div class="flex-shrink-0 mt-0.5">
              <div :class="getEventIcon(event.type)"></div>
            </div>
            <div class="flex-1 min-w-0">
              <p class="text-sm text-gray-900" x-text="event.message"></p>
              <p
                class="text-xs text-gray-500 mt-1"
                x-text="formatTime(event.timestamp)"
              ></p>
            </div>
          </div>
        </div>
      </template>
      <div x-show="events.length === 0" class="p-12 text-center">
        <svg
          class="w-12 h-12 mx-auto text-gray-400 mb-2"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"
          ></path>
        </svg>
        <p class="text-sm text-gray-500">Aucun événement</p>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block extra_js %}
<script>
  function dashboard() {
    return {
      connected: false,
      ws: null,
      stats: {
        connected: 0,
        total: 0,
        logsToday: 0,
        logsRate: 0,
        messages: 0,
        messageRate: 0,
        latency: 0,
        latencyP95: 0,
      },
      terminals: [],
      logs: [],
      events: [],

      init() {
        this.connectWebSocket();
        this.refreshAll();
        setInterval(() => this.refreshAll(), 30000);
      },

      connectWebSocket() {
        const protocol = window.location.protocol === "https:" ? "wss:" : "ws:";
        const wsUrl = `${protocol}//${window.location.host}/ws/dashboard/`;

        this.ws = new WebSocket(wsUrl);

        this.ws.onopen = () => {
          this.connected = true;
          this.addEvent("info", "Connexion WebSocket établie");
        };

        this.ws.onclose = () => {
          this.connected = false;
          this.addEvent("error", "Connexion WebSocket fermée");
          setTimeout(() => this.connectWebSocket(), 5000);
        };

        this.ws.onerror = (error) => {
          this.addEvent("error", "Erreur WebSocket");
        };

        this.ws.onmessage = (event) => {
          const data = JSON.parse(event.data);
          this.handleWebSocketMessage(data);
        };
      },

      handleWebSocketMessage(data) {
        if (data.type === "stats") {
          this.stats = { ...this.stats, ...data.data };
        } else if (data.type === "terminal_update") {
          this.updateTerminal(data.data);
        } else if (data.type === "new_log") {
          this.addLog(data.data);
        } else if (data.type === "event") {
          this.addEvent(data.level || "info", data.message);
        }
      },

      async refreshAll() {
        try {
          const response = await fetch("/api/dashboard/data/");
          const data = await response.json();

          if (data.stats) this.stats = { ...this.stats, ...data.stats };
          if (data.terminals) this.terminals = data.terminals;
          if (data.logs) this.logs = data.logs.slice(0, 20);
        } catch (error) {
          console.error("Error refreshing data:", error);
        }
      },

      updateTerminal(terminal) {
        const index = this.terminals.findIndex((t) => t.id === terminal.id);
        if (index >= 0) {
          this.terminals[index] = terminal;
        } else {
          this.terminals.push(terminal);
        }
      },

      addLog(log) {
        this.logs.unshift(log);
        if (this.logs.length > 20) this.logs.pop();
        this.stats.logsToday++;
      },

      addEvent(type, message) {
        this.events.unshift({
          id: Date.now(),
          type,
          message,
          timestamp: new Date().toISOString(),
        });
        if (this.events.length > 50) this.events.pop();
      },

      getEventIcon(type) {
        const icons = {
          info: "w-2 h-2 rounded-full bg-blue-400",
          success: "w-2 h-2 rounded-full bg-green-400",
          warning: "w-2 h-2 rounded-full bg-yellow-400",
          error: "w-2 h-2 rounded-full bg-red-400",
        };
        return icons[type] || icons.info;
      },

      formatTime(timestamp) {
        if (!timestamp) return "";
        const date = new Date(timestamp);
        const now = new Date();
        const diff = Math.floor((now - date) / 1000);

        if (diff < 60) return "À l'instant";
        if (diff < 3600) return `Il y a ${Math.floor(diff / 60)}m`;
        if (diff < 86400) return `Il y a ${Math.floor(diff / 3600)}h`;

        return date.toLocaleString("fr-FR", {
          day: "2-digit",
          month: "2-digit",
          hour: "2-digit",
          minute: "2-digit",
        });
      },
    };
  }
</script>
{% endblock %}
